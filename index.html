
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <title>CẤP SỐ NHÂN - Bàn cờ vua & phần thưởng hạt thóc</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
      color: #333;
      text-align: center;
    }
    h1 { color: #006400; }
    .chessboard {
      display: grid;
      grid-template-columns: repeat(8, 60px);
      grid-template-rows: repeat(8, 60px);
      margin: 20px auto;
      border: 4px solid #333;
      width: fit-content;
    }
    .square {
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      font-size: 10px;
      font-weight: bold;
      padding: 4px;
      text-align: center;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      position: relative;
    }
    .white { background-color: #f0d9b5; }
    .black { background-color: #b58863; }
    .tooltip {
      visibility: hidden;
      background-color: #333;
      color: #fff;
      font-size: 12px;
      text-align: left;
      border-radius: 4px;
      padding: 4px 6px;
      position: absolute;
      bottom: 65px;
      z-index: 1;
      opacity: 0;
      transition: opacity 0.3s;
      width: 160px;
    }
    .square:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
    .info, .controls {
      margin-top: 20px;
      font-size: 16px;
    }
    .result {
      font-weight: bold;
      color: darkred;
      margin-top: 10px;
    }
    button {
      margin: 5px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }
    .counting { display: block; }
    .main-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
    }
    #right-image img {
      width: 240px;
      border-radius: 8px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
      border: 2px solid #333;
    }
  </style>
</head>
<body>
<h1>CẤP SỐ NHÂN - Bàn cờ vua & phần thưởng hạt thóc</h1>
<div class="info">Tooltip chi tiết khi di chuột vào ô</div>
<div class="controls">
  <button onclick="showNext()">Hiện 1 ô</button>
  <button onclick="showAll()">Hiện tự động</button>
</div>


<div class="main-container">
  <div style="text-align: left;">
    <img src="vua.png" style="width: 240px; display: block; margin-bottom: 12px; border: 2px solid #444; border-radius: 12px; box-shadow: 2px 2px 6px rgba(0,0,0,0.3);"/>
    <div style="font-style: italic; padding: 8px; background: #fff8dc; border-left: 4px solid #006400; border-radius: 6px; box-shadow: 1px 1px 4px rgba(0,0,0,0.2); max-width: 240px;">
      Tâu bệ hạ, thần không dám đòi hỏi châu báu hay vàng bạc. Thần chỉ xin bệ hạ ban thưởng cho thần số hạt thóc đặt lên bàn cờ này. Cụ thể, xin cho ô đầu tiên 1 hạt thóc, ô thứ hai 2 hạt, ô thứ ba 4 hạt... Cứ thế, mỗi ô sau sẽ có số hạt gấp đôi ô trước, cho đến khi đủ cả 64 ô.
    </div>
  </div>

  <div>
    <div class="chessboard" id="chessboard">
      <!-- Các ô sẽ được JS tạo -->
    </div>
    <div class="info result">Tổng số hạt thóc: <span id="totalGrains">0</span></div>
  </div>
  <div id="right-image"></div>
</div>

<script>
let current = 0;
const values = Array.from({length: 64}, (_, i) => 2 ** i);
const milestones = [3, 6, 9, 16, 32, 64];

function formatNumber(num) {
  let s = num.toString();
  let parts = [];
  while (s.length > 6) {
    parts.unshift(s.slice(-6));
    s = s.slice(0, -6);
  }
  parts.unshift(s);
  return parts.join("<br>");
}

function animateCount(id, target) {
  const element = document.getElementById(id);
  let currentVal = 0;
  const step = Math.max(1, Math.floor(target / 30));
  const interval = setInterval(() => {
    currentVal += step;
    if (currentVal >= target) {
      element.innerHTML = formatNumber(target);
      clearInterval(interval);
    } else {
      element.innerHTML = formatNumber(currentVal);
    }
  }, 20);
}

function updateTotal() {
  let total = 0;
  for (let i = 0; i < current; i++) total += values[i];
  document.getElementById("totalGrains").innerText = total.toLocaleString('vi-VN');
}

function showNext() {
  if (current < 64) {
    animateCount("cell" + current, values[current]);
    current++;
    updateTotal();
    checkMilestone(current);
  }
}

function showAll() {
  if (current >= 64) return;
  const interval = setInterval(() => {
    if (current >= 64) {
      clearInterval(interval);
    } else {
      animateCount("cell" + current, values[current]);
      current++;
      updateTotal();
      checkMilestone(current);
    }
  }, 100);
}

function checkMilestone(step) {
  if (milestones.includes(step)) {
    const imgDiv = document.getElementById("right-image");
    imgDiv.innerHTML = `<img src="${step}.png" alt="Mốc ${step}"/>`;
  }
}

function buildBoard() {
  const board = document.getElementById("chessboard");
  for (let i = 0; i < 64; i++) {
    const square = document.createElement("div");
    square.className = "square " + ((Math.floor(i / 8) + i) % 2 === 0 ? "white" : "black");
    square.innerHTML = `
      <div class="counting" id="cell${i}"></div>
      <div class="tooltip">Ô số ${i + 1}<br/>Tổng đến đây: ${values.slice(0, i + 1).reduce((a, b) => a + b, 0).toLocaleString('vi-VN')}</div>
    `;
    board.appendChild(square);
  }
}
buildBoard();
</script>

<canvas height="400" id="grainChart" style="margin-top: 30px;" width="800"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function drawChart() {
    const ctx = document.getElementById('grainChart').getContext('2d');
    const chartData = {
        labels: Array.from({length: 64}, (_, i) => 'Ô ' + (i + 1)),
        datasets: [{
            label: 'Số hạt ở mỗi ô',
            data: values,
            backgroundColor: 'rgba(34, 139, 34, 0.7)',
            borderWidth: 1
        }]
    };
    new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Số hạt (log hoặc tuyến tính)'
                    },
                    ticks: {
                        callback: function(value) {
                            return Number(value).toLocaleString();
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Vị trí ô (1 → 64)'
                    },
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 20
                    }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.raw.toLocaleString() + ' hạt';
                        }
                    }
                }
            }
        }
    });
}

// Gọi vẽ biểu đồ sau khi hiện toàn bộ
function showAll() {
    if (current >= 64) return;
    const interval = setInterval(() => {
        if (current >= 64) {
            clearInterval(interval);
            setTimeout(drawChart, 500);
        } else {
            animateCount("cell" + current, values[current]);
            current++;
            updateTotal();
            checkMilestone(current);
        }
    }, 100);
}
</script>

</body>
</html>
